import { TILE_HEIGHT, TILE_WIDTH } from "../../config/constants.js";
import { createBulletTexture } from "./bullet.js";
import {
  createAppleTexture,
  createBoarChunkTexture,
  createPearTexture,
} from "./items.js";
import { createNpcTexture } from "./npc.js";
import { createFriendlyNpcTexture } from "./npcFriend.js";
import { createPigTexture } from "./pig.js";
import { createPlayerTexture } from "./player.js";
import {
  createSpellMeditateTexture,
  createSpellShieldTexture,
  createSpellShotTexture,
} from "./spells.js";
import { createCollisionTilesTexture } from "./terrain/collision.js";
import { createGrassTexture } from "./terrain/grass.js";
import { createGraveyardTexture } from "./terrain/graveyard.js";
import { createMountainTexture } from "./terrain/mountain.js";
import { createPondTexture } from "./terrain/pond.js";
import { createRockTexture } from "./terrain/rock.js";
import { createCaveEntranceTexture } from "./terrain/caveEntrance.js";
import { createTavernEntranceTexture } from "./terrain/tavernEntrance.js";
import {
  createConiferTexture,
  createDeciduousTexture,
} from "./terrain/trees.js";
import { createWallTexture } from "./terrain/wall.js";

const playerFrameWidth = 32;
const playerFrameHeight = 32;
const playerFrameCount = 24;
const playerSheetWidth = playerFrameWidth * playerFrameCount;
const playerSheetHeight = playerFrameHeight;

const mountainVariants = [
  { width: TILE_WIDTH, height: TILE_HEIGHT * 1.2 },
  { width: Math.round(TILE_WIDTH * 1.4), height: TILE_HEIGHT * 1.6 },
  { width: TILE_WIDTH * 2, height: TILE_HEIGHT * 2.2 },
];
const mountainTopMax = Math.max(...mountainVariants.map((variant) => variant.width / 2));
const mountainVerticalMax = Math.max(
  ...mountainVariants.map((variant) => variant.height)
);
const mountainFrameHeight = Math.ceil(mountainTopMax + mountainVerticalMax);
const mountainTotalWidth = mountainVariants.reduce(
  (sum, variant) => sum + variant.width,
  0
);

export const textureRegistry = [
  {
    id: "grass",
    type: "terrain",
    size: { width: TILE_WIDTH * 2, height: TILE_HEIGHT },
    palette: ["#4d8f52", "#4a824c", "#3a6b3e", "#5fa663"],
    rarity: "common",
    isAnimated: false,
    tags: ["ground", "tile"],
    effectTag: "terrain",
    materialType: "grass",
    impactVFX: "grass-dust",
    soundId: "step-grass",
    lightEmission: 0,
    version: 1,
    create: createGrassTexture,
  },
  {
    id: "graveyard",
    type: "terrain",
    size: { width: TILE_WIDTH * 2, height: TILE_HEIGHT },
    palette: ["#5b5f65", "#4f5359", "#3a3d41", "#9ba1a7"],
    rarity: "uncommon",
    isAnimated: false,
    tags: ["ground", "tile", "graveyard"],
    effectTag: "terrain",
    materialType: "stone",
    impactVFX: "rock-dust",
    soundId: "step-stone",
    lightEmission: 0,
    version: 1,
    create: createGraveyardTexture,
  },
  {
    id: "rock",
    type: "terrain",
    size: { width: TILE_WIDTH * 2, height: TILE_HEIGHT },
    palette: ["#6b6f78", "#5e636c", "#494d54", "#7d838d"],
    rarity: "common",
    isAnimated: false,
    tags: ["ground", "tile"],
    effectTag: "terrain",
    materialType: "stone",
    impactVFX: "rock-dust",
    soundId: "step-stone",
    lightEmission: 0,
    version: 1,
    create: createRockTexture,
  },
  {
    id: "wall",
    type: "terrain",
    size: { width: TILE_WIDTH, height: TILE_HEIGHT * 2 },
    palette: ["#9e7648", "#7a5c3b", "#8a663f"],
    rarity: "common",
    isAnimated: false,
    tags: ["structure", "tile"],
    effectTag: "structure",
    materialType: "wood",
    impactVFX: "wood-splinter",
    soundId: "hit-wood",
    lightEmission: 0,
    version: 1,
    create: createWallTexture,
  },
  {
    id: "mountains",
    type: "terrain",
    size: { width: mountainTotalWidth, height: mountainFrameHeight },
    palette: ["#9a8b78", "#776956", "#857462", "#6c5f4f"],
    rarity: "uncommon",
    isAnimated: false,
    tags: ["terrain", "tile", "obstacle"],
    effectTag: "terrain",
    materialType: "stone",
    impactVFX: "rock-dust",
    soundId: "step-stone",
    lightEmission: 0,
    version: 1,
    create: createMountainTexture,
  },
  {
    id: "cave-entrance",
    type: "terrain",
    size: { width: TILE_WIDTH, height: TILE_HEIGHT },
    palette: ["#3f4248", "#2b2f33", "#6b6f78", "#1b1d20"],
    rarity: "common",
    isAnimated: false,
    tags: ["structure", "tile", "portal"],
    effectTag: "structure",
    materialType: "stone",
    impactVFX: "stone-chip",
    soundId: "step-stone",
    lightEmission: 0,
    version: 1,
    create: createCaveEntranceTexture,
  },
  {
    id: "tavern-entrance",
    type: "terrain",
    size: { width: TILE_WIDTH, height: TILE_HEIGHT },
    palette: ["#b58a5a", "#8a623e", "#7a3a2b", "#4b2d1a"],
    rarity: "common",
    isAnimated: false,
    tags: ["structure", "tile", "portal"],
    effectTag: "structure",
    materialType: "wood",
    impactVFX: "wood-splinter",
    soundId: "hit-wood",
    lightEmission: 0.1,
    version: 1,
    create: createTavernEntranceTexture,
  },
  {
    id: "pond",
    type: "terrain",
    size: { width: TILE_WIDTH, height: TILE_HEIGHT },
    palette: ["#2f6f8a", "#214e60", "#4aa0bf"],
    rarity: "uncommon",
    isAnimated: false,
    tags: ["water", "tile"],
    effectTag: "terrain",
    materialType: "water",
    impactVFX: "splash",
    soundId: "water-splash",
    lightEmission: 0.1,
    version: 1,
    create: createPondTexture,
  },
  {
    id: "tree-conifer",
    type: "terrain",
    size: { width: TILE_WIDTH * 2, height: TILE_HEIGHT * 4 },
    palette: ["#2f6b3b", "#2a5f34", "#234d2b", "#7a5a3a", "#1c3a22"],
    rarity: "common",
    isAnimated: false,
    tags: ["foliage", "tree"],
    effectTag: "foliage",
    materialType: "wood",
    impactVFX: "leaf-rustle",
    soundId: "foliage",
    lightEmission: 0,
    version: 1,
    create: createConiferTexture,
  },
  {
    id: "tree-deciduous",
    type: "terrain",
    size: { width: TILE_WIDTH * 2, height: TILE_HEIGHT * 4 },
    palette: ["#4c8f4f", "#5da85e", "#3d713e", "#8a623e"],
    rarity: "common",
    isAnimated: false,
    tags: ["foliage", "tree"],
    effectTag: "foliage",
    materialType: "wood",
    impactVFX: "leaf-rustle",
    soundId: "foliage",
    lightEmission: 0,
    version: 1,
    create: createDeciduousTexture,
  },
  {
    id: "collision-tiles",
    type: "collision",
    size: { width: TILE_WIDTH, height: TILE_WIDTH },
    palette: ["#000000"],
    rarity: "common",
    isAnimated: false,
    tags: ["debug", "collision"],
    effectTag: "collision",
    materialType: "debug",
    impactVFX: "none",
    soundId: "none",
    lightEmission: 0,
    version: 1,
    create: createCollisionTilesTexture,
  },
  {
    id: "player",
    type: "character",
    size: { width: playerFrameWidth, height: playerFrameHeight },
    palette: [
      "#1b2336",
      "#26324a",
      "#2d3a56",
      "#8b5a3c",
      "#f1d18a",
      "#4b2c20",
      "#c84b31",
      "#6d4c41",
      "#3b3f58",
      "#5a6b7f",
      "#445266",
      "#c66b5b",
      "#9c3f2f",
    ],
    rarity: "common",
    isAnimated: true,
    tags: ["player", "sprite"],
    effectTag: "player",
    materialType: "flesh",
    impactVFX: "hit-flesh",
    soundId: "step-leather",
    lightEmission: 0,
    version: 1,
    create: createPlayerTexture,
  },
  {
    id: "player-sheet",
    type: "sprite-sheet",
    size: { width: playerSheetWidth, height: playerSheetHeight },
    palette: [
      "#1b2336",
      "#26324a",
      "#2d3a56",
      "#8b5a3c",
      "#f1d18a",
      "#4b2c20",
      "#c84b31",
      "#6d4c41",
      "#3b3f58",
      "#5a6b7f",
      "#445266",
      "#c66b5b",
      "#9c3f2f",
    ],
    rarity: "common",
    isAnimated: true,
    tags: ["player", "sheet"],
    effectTag: "player",
    materialType: "flesh",
    impactVFX: "hit-flesh",
    soundId: "step-leather",
    lightEmission: 0,
    version: 1,
    create: createPlayerTexture,
  },
  {
    id: "npc",
    type: "npc",
    size: { width: 32, height: 32 },
    palette: ["#1a1d2e", "#e2b714"],
    rarity: "common",
    isAnimated: false,
    tags: ["npc", "hostile"],
    effectTag: "npc-hostile",
    materialType: "flesh",
    impactVFX: "hit-flesh",
    soundId: "npc-hostile",
    lightEmission: 0,
    version: 1,
    create: createNpcTexture,
  },
  {
    id: "npcFriend",
    type: "npc",
    size: { width: 32, height: 32 },
    palette: ["#1d2c3b", "#7ad0ff", "#0f1a24"],
    rarity: "common",
    isAnimated: false,
    tags: ["npc", "friendly"],
    effectTag: "npc-friendly",
    materialType: "flesh",
    impactVFX: "hit-flesh",
    soundId: "npc-friendly",
    lightEmission: 0,
    version: 1,
    create: createFriendlyNpcTexture,
  },
  {
    id: "pig",
    type: "npc",
    size: { width: 32, height: 32 },
    palette: ["#f4a7b9", "#f7c4d2", "#8a5568", "#2b1e26"],
    rarity: "common",
    isAnimated: false,
    tags: ["npc", "animal"],
    effectTag: "npc-neutral",
    materialType: "flesh",
    impactVFX: "hit-flesh",
    soundId: "npc-neutral",
    lightEmission: 0,
    version: 1,
    create: createPigTexture,
  },
  {
    id: "bullet",
    type: "projectile",
    size: { width: 10, height: 10 },
    palette: ["#f6f2ee"],
    rarity: "common",
    isAnimated: false,
    tags: ["combat", "projectile"],
    effectTag: "projectile",
    materialType: "metal",
    impactVFX: "spark",
    soundId: "bullet-hit",
    lightEmission: 0,
    version: 1,
    create: createBulletTexture,
  },
  {
    id: "apple",
    type: "item",
    size: { width: 20, height: 20 },
    palette: ["#d83b2d", "#4d7c2d"],
    rarity: "common",
    isAnimated: false,
    tags: ["food", "collectible"],
    effectTag: "item",
    materialType: "organic",
    impactVFX: "item-pop",
    soundId: "item-pickup",
    lightEmission: 0,
    version: 1,
    create: createAppleTexture,
  },
  {
    id: "pear",
    type: "item",
    size: { width: 20, height: 20 },
    palette: ["#d8c83b", "#6b8f3a"],
    rarity: "common",
    isAnimated: false,
    tags: ["food", "collectible"],
    effectTag: "item",
    materialType: "organic",
    impactVFX: "item-pop",
    soundId: "item-pickup",
    lightEmission: 0,
    version: 1,
    create: createPearTexture,
  },
  {
    id: "boar_chunk",
    type: "item",
    size: { width: 20, height: 20 },
    palette: ["#b06a5b", "#7a3f36", "#f0d8c4"],
    rarity: "common",
    isAnimated: false,
    tags: ["food", "collectible"],
    effectTag: "item",
    materialType: "organic",
    impactVFX: "item-pop",
    soundId: "item-pickup",
    lightEmission: 0,
    version: 1,
    create: createBoarChunkTexture,
  },
  {
    id: "spell-shot",
    type: "spell",
    size: { width: 20, height: 20 },
    palette: ["#f6d35b", "#f29f3d"],
    rarity: "rare",
    isAnimated: false,
    tags: ["spell", "projectile"],
    effectTag: "spell",
    materialType: "arcane",
    impactVFX: "magic-burst",
    soundId: "spell-cast",
    lightEmission: 0.6,
    version: 1,
    create: createSpellShotTexture,
  },
  {
    id: "spell-shield",
    type: "spell",
    size: { width: 20, height: 20 },
    palette: ["#6bb8ff", "#d6f0ff"],
    rarity: "rare",
    isAnimated: false,
    tags: ["spell", "defense"],
    effectTag: "spell",
    materialType: "arcane",
    impactVFX: "magic-shield",
    soundId: "spell-shield",
    lightEmission: 0.8,
    version: 1,
    create: createSpellShieldTexture,
  },
  {
    id: "spell-meditate",
    type: "spell",
    size: { width: 20, height: 20 },
    palette: ["#7ed6a5", "#d6f5e2"],
    rarity: "rare",
    isAnimated: false,
    tags: ["spell", "restoration"],
    effectTag: "spell",
    materialType: "arcane",
    impactVFX: "magic-burst",
    soundId: "spell-cast",
    lightEmission: 0.4,
    version: 1,
    create: createSpellMeditateTexture,
  },
];

export const createRegisteredTextures = (scene) => {
  textureRegistry.forEach((texture) => texture.create(scene));
};

export const textureProperties = new Map(
  textureRegistry.map((texture) => [
    texture.id,
    {
      id: texture.id,
      effectTag: texture.effectTag,
      materialType: texture.materialType,
      impactVFX: texture.impactVFX,
      soundId: texture.soundId,
      lightEmission: texture.lightEmission,
      type: texture.type,
      tags: texture.tags,
      rarity: texture.rarity,
    },
  ])
);

export const getTextureProperties = (textureId) =>
  textureProperties.get(textureId);

export const getTextureIdByEffectTag = (effectTag) => {
  if (!effectTag) {
    return null;
  }
  return textureRegistry.find((texture) => texture.effectTag === effectTag)?.id ?? null;
};
